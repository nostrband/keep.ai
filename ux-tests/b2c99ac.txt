# UX Test Report: Commit b2c99ac
## Maintenance Mode for Automatic Script Error Fixing

**Date:** 2026-01-20
**Commit:** b2c99ac - Implement maintenance mode for automatic script error fixing

---

## Summary

The maintenance mode feature is correctly implemented. When logic errors occur, workflows enter maintenance mode, the agent receives error context for auto-fixing, and the UI shows "Auto-fixing issue..." status. Code review confirms correct implementation.

---

## Test Results

### Test 1: Maintenance Mode UI Display
**Status:** VERIFIED (code review)

When a workflow enters maintenance mode, the UI correctly shows:
- "Auto-fixing issue..." as secondary text (not marked as needing attention)
- No red border (maintenance is not user-actionable)

**Code verified (MainPage.tsx lines 57-61):**
```typescript
if (workflow.maintenance) {
  return { text: "Auto-fixing issue...", isAttention: false };
}
```

### Test 2: Maintenance Mode Entry Flow
**Status:** VERIFIED (code review)

The flow works correctly:
1. Logic error occurs during workflow execution
2. `enterMaintenanceMode()` is called in workflow-worker.ts
3. Maintenance flag is set to true
4. Fix count is incremented
5. Error context is sent to planner inbox
6. "maintenance_started" chat event is created
7. "maintenance" signal is emitted to scheduler

### Test 3: Scheduler Skips Maintenance Workflows
**Status:** VERIFIED (code review)

**Code (workflow-scheduler.ts line 200-201):**
```typescript
const activeWorkflows = allWorkflows.filter(
  (w) => w.status === 'active' && !w.maintenance
);
```

Workflows in maintenance mode are correctly filtered out from scheduling.

### Test 4: Maintenance Mode Exit Flow
**Status:** VERIFIED (code review)

When agent saves a fix via save.ts:
1. Checks if workflow was in maintenance
2. Clears maintenance flag
3. Sets next_run_timestamp to now (triggers immediate re-run)
4. Creates "maintenance_fixed" chat event

### Test 5: Fix Count and Escalation
**Status:** VERIFIED (code review)

- MAX_FIX_ATTEMPTS = 3
- After 3 failed fix attempts, escalateToUser() is called
- Workflow is paused and user is notified

### Test 6: Live Maintenance Mode Testing
**Status:** NOT TESTED (no workflows to trigger errors)

Could not trigger actual maintenance mode as no workflows existed in the test environment.

---

## Code Review: Potential Issues

### ISSUE 1: Stale Workflow Object in save.ts (MEDIUM SEVERITY)

**Location:** `/packages/agent/src/ai-tools/save.ts` (line 69)

**Problem:** Uses spread pattern instead of atomic field updates:

```typescript
const workflow = await opts.scriptStore.getWorkflowByTaskId(opts.taskId);  // Fetch early
// ... other operations ...
await opts.scriptStore.updateWorkflow({
  ...workflow,  // Stale data - could overwrite concurrent changes
  maintenance: false,
  next_run_timestamp: new Date().toISOString(),
});
```

**Impact:** If the workflow is modified between the fetch (line 37) and the update (line 69), such as a user pausing the workflow, those changes will be overwritten.

**Recommendation:** Use `updateWorkflowFields()` instead:
```typescript
await opts.scriptStore.updateWorkflowFields(workflow.id, {
  maintenance: false,
  next_run_timestamp: new Date().toISOString(),
});
```

The codebase already uses `updateWorkflowFields()` in workflow-worker.ts and workflow-scheduler.ts for this exact reason (see workflow-worker.ts lines 189-192, 299-302, etc.).

### ISSUE 2: Chat Event Routing Inconsistency (LOW SEVERITY)

**Location:** workflow-worker.ts vs save.ts

- `maintenance_started` event uses `task.chat_id`
- `maintenance_fixed` event uses hardcoded `"main"` chat

**Impact:** Events may appear in different chat contexts, potentially confusing.

### ISSUE 3: No Inbox Deduplication (LOW SEVERITY)

**Location:** `/packages/agent/src/workflow-worker.ts` (line 589)

Each maintenance request creates a new inbox item with a unique ID:
```typescript
const inboxId = `maintenance.${workflow.id}.${scriptRunId}.${generateId()}`;
```

If a workflow triggers multiple maintenance requests before the agent fixes the first one, duplicate work may be assigned.

---

## Implementation Quality

### Strengths
1. **Clean Architecture:** Clear separation between entry, handling, and exit
2. **Error Context:** Agent receives full script code, error details, and recent logs
3. **Gradual Escalation:** Max 3 fix attempts before escalating to user
4. **Good Observability:** Chat events track the maintenance lifecycle
5. **Atomic Field Updates:** workflow-worker.ts correctly uses updateWorkflowFields()

### Database Changes
- Migration v18: Added `maintenance` boolean column to workflows table
- Migration v21: Added `maintenance_fix_count` integer column

### Files Changed
- Modified: 10 files including workflow-worker.ts, workflow-scheduler.ts, save.ts
- New migration: v18.ts

---

## Conclusion

**PASS** - The maintenance mode feature is correctly implemented. Logic errors trigger automatic agent fixing, the UI displays appropriate status, and the workflow lifecycle is properly managed.

**Action Item:** The save.ts file should be updated to use `updateWorkflowFields()` instead of `updateWorkflow({...workflow, ...})` to prevent race conditions with concurrent workflow modifications. This is the same pattern fix that was applied to workflow-worker.ts and workflow-scheduler.ts.

================================================================================
ISSUE REVIEW
================================================================================
- Issue #1 (Stale Workflow Object in save.ts) - created specs/save-ts-atomic-workflow-update.md
- Issue #2 (Chat Event Routing Inconsistency) - created specs/maintenance-fixed-event-chat-routing.md
- Issue #3 (No Inbox Deduplication) - skipped

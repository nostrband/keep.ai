COMMIT: 7a24d70
TITLE: Implement per-device notification tracking
DATE: 2026-01-16

==============================================================================
SUMMARY OF CHANGES
==============================================================================

This commit implements per-device notification tracking to fix a multi-device
issue where notifications would only appear on one device. Previously, a
global `read_at` timestamp on the `chats` table meant that if Device A showed
a notification, Device B would never receive it.

FILES CHANGED (6 files, +168/-9 lines):
- IMPLEMENTATION_PLAN.md - Updated documentation
- apps/web/src/lib/MessageNotifications.ts - Uses per-device tracking
- packages/db/src/api.ts - Added getDeviceId() and getNewAssistantMessagesForDevice()
- packages/db/src/chat-store.ts - Added markChatNotifiedOnDevice() and getChatNotifiedAt()
- packages/db/src/database.ts - Registered migration v23
- packages/db/src/migrations/v23.ts - New migration creating chat_notifications table

==============================================================================
DETAILED ANALYSIS
==============================================================================

1. MIGRATION v23 (packages/db/src/migrations/v23.ts)

   Creates a LOCAL table (intentionally NOT a CRR/conflict-free replicated table):

   CREATE TABLE chat_notifications (
     chat_id TEXT NOT NULL,
     device_id TEXT NOT NULL,
     notified_at TEXT NOT NULL,
     PRIMARY KEY (chat_id, device_id)
   )

   Also creates index: idx_chat_notifications_device ON (device_id, notified_at)

   The table is local-only by design because:
   - Notification tracking is device-specific
   - Each device maintains independent notification state
   - Syncing would defeat the purpose of per-device tracking

   This follows the pattern of other local tables like crsql_change_history (v7)
   and all_peers (v8).

2. API CHANGES (packages/db/src/api.ts)

   New getDeviceId() method:
   - Queries cr-sqlite's crsql_site_id() to get unique device identifier
   - Returns site_id as hex string using bytesToHex()
   - The site_id is auto-generated by cr-sqlite and persists across restarts

   New getNewAssistantMessagesForDevice() method:
   - LEFT JOINs messages with chat_notifications filtered by device_id
   - Returns messages where notified_at IS NULL OR created_at > notified_at
   - Properly deprecates the old getNewAssistantMessages() method

3. CHAT STORE CHANGES (packages/db/src/chat-store.ts)

   New markChatNotifiedOnDevice() method:
   - Uses INSERT OR REPLACE to update notification timestamp
   - Takes chatId, deviceId, and optional timestamp

   New getChatNotifiedAt() method:
   - Retrieves last notification timestamp for chat on specific device
   - Returns null if never notified

4. MESSAGE NOTIFICATIONS (apps/web/src/lib/MessageNotifications.ts)

   - Caches deviceId after first retrieval
   - Uses getNewAssistantMessagesForDevice() instead of getNewAssistantMessages()
   - Calls markChatNotifiedOnDevice() instead of readChat()
   - Notifies "chat_notifications" table changed instead of "chats"

==============================================================================
POTENTIAL ISSUES
==============================================================================

ISSUE 1: INEFFECTIVE notifyTablesChanged CALL
Severity: Low (Code Quality)
Location: apps/web/src/lib/MessageNotifications.ts:47

The call `notifyTablesChanged(["chat_notifications"], true, api)` is effectively
a no-op because no React Query hooks subscribe to the "chat_notifications" table.
No queries have `meta: { tables: ["chat_notifications"] }`.

Impact: None functionally - just dead code.

ISSUE 2: NO CLEANUP WHEN CHATS ARE DELETED
Severity: Medium (Data Accumulation)
Location: packages/db/src/chat-store.ts:63-75 (deleteChat method)

When a chat is deleted via deleteChat(), the corresponding rows in
chat_notifications are NOT cleaned up. This creates orphaned records.

The table will grow indefinitely with orphaned entries for deleted chats.
Over time, this could bloat the local database.

Impact: Database bloat on devices with many deleted chats.

ISSUE 3: NO TRANSACTION PARAMETER ON NEW METHODS
Severity: Low (API Consistency)
Location: packages/db/src/chat-store.ts:340-373

The new methods markChatNotifiedOnDevice() and getChatNotifiedAt() do not
accept an optional `tx?: DBInterface` parameter like other methods in the
same file (e.g., createChat, deleteChat).

This prevents these methods from being part of larger atomic operations.

Impact: Cannot include notification marking in a transaction with other operations.

ISSUE 4: NO VALIDATION OF DEVICE ID
Severity: Low (Robustness)
Location: packages/db/src/chat-store.ts:340-352, packages/db/src/api.ts:165

The methods accept any string as deviceId without validating it's a valid
16-byte hex string. An invalid deviceId could create inconsistent data.

Impact: Potential data inconsistency if invalid deviceId is passed.

ISSUE 5: QUERY LOGIC POTENTIAL EDGE CASE
Severity: Low (Correctness)
Location: packages/db/src/api.ts:175-180

The query in getNewAssistantMessagesForDevice uses:
  WHERE (cn.notified_at IS NULL OR m.created_at > cn.notified_at)

For strict ordering, this should arguably use >= instead of > to catch
messages created at exactly the same timestamp. However, in practice,
ISO timestamps with millisecond precision make collisions extremely rare.

Impact: Theoretically could miss messages created at exact same ms as
notification, but practically unlikely.

==============================================================================
PROPOSALS
==============================================================================

PROPOSAL 1: Remove ineffective notifyTablesChanged call
Simplicity: Very Simple

Either remove the call entirely since no queries depend on it, or add a
comment explaining it's kept for consistency/future use.

--- a/apps/web/src/lib/MessageNotifications.ts
+++ b/apps/web/src/lib/MessageNotifications.ts
@@ -44,7 +44,6 @@ export class MessageNotifications {
           message.metadata!.threadId!,
           this.deviceId
         );
-        notifyTablesChanged(["chat_notifications"], true, api);

PROPOSAL 2: Add cleanup in deleteChat
Simplicity: Simple

Delete orphaned notification records when a chat is deleted:

--- a/packages/db/src/chat-store.ts
+++ b/packages/db/src/chat-store.ts
@@ -72,6 +72,9 @@ export class ChatStore {
     // Also delete the chat itself
     const db = tx || this.db.db;
+    // Clean up per-device notification records (local table, not synced)
+    await db.exec(`DELETE FROM chat_notifications WHERE chat_id = ?`, [chatId]);
+
     await db.exec(`DELETE FROM chats WHERE id = ?`, [chatId]);
   }

PROPOSAL 3: Add transaction parameter to new methods
Simplicity: Simple

--- a/packages/db/src/chat-store.ts
+++ b/packages/db/src/chat-store.ts
@@ -336,7 +336,8 @@ export class ChatStore {
   async markChatNotifiedOnDevice(
     chatId: string,
     deviceId: string,
-    timestamp?: string
+    timestamp?: string,
+    tx?: DBInterface
   ): Promise<void> {
     const notifiedAt = timestamp || new Date().toISOString();
+    const db = tx || this.db.db;

-    await this.db.db.exec(
+    await db.exec(
       `INSERT OR REPLACE INTO chat_notifications (chat_id, device_id, notified_at)
        VALUES (?, ?, ?)`,
       [chatId, deviceId, notifiedAt]
     );
   }

PROPOSAL 4: Add deviceId validation (optional)
Simplicity: Simple

Add a helper function to validate hex device IDs:

function isValidDeviceId(id: string): boolean {
  return /^[0-9a-f]{32}$/i.test(id);
}

Then check in methods:
  if (!isValidDeviceId(deviceId)) {
    throw new Error("Invalid device ID format");
  }

==============================================================================
VERDICT
==============================================================================

MEDIUM-RISK COMMIT: Well-designed solution for a real multi-device issue.
The core implementation is correct and follows established patterns in the
codebase. Issues identified are mostly about cleanup and consistency, not
correctness. The orphaned records issue (Issue 2) is the most impactful
and should be addressed before the data accumulates.

RECOMMENDED ACTIONS:
1. HIGH: Add cleanup in deleteChat (Proposal 2)
2. LOW: Remove or comment the ineffective notifyTablesChanged call
3. LOW: Add transaction parameters for consistency

================================================================================
ISSUE REVIEW
================================================================================
- Issue #1 (Ineffective notifyTablesChanged call) - skipped
- Issue #2 (No cleanup when chats deleted) - skipped
- Issue #3 (No transaction parameter) - skipped
- Issue #4 (No validation of device ID) - skipped (deviceId always from trusted crsql_site_id)
- Issue #5 (Query logic edge case) - skipped (practically unlikely)

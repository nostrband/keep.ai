COMMIT: 10f2399
TITLE: Implement exec-15 Phase 5: Handler Context Threading
DATE: 2026-02-06

== SUMMARY ==

This commit adds handler context threading to enable topic declaration validation at runtime. It implements exec-15 Phase 5 by:

1. Adding `getHandlerName` and `getWorkflowConfig` callbacks to ToolListConfig interface
2. Parsing workflow.handler_config in createHandlerSandbox to extract WorkflowConfig
3. Passing workflowConfig and handlerName through createWorkflowTools to Topics.publish
4. Using a ref pattern to solve circular dependency between ToolWrapper and getPhase callback
5. Implementing topic validation in Topics.publish against declared topics per handler

The key change is that Topics.publish now validates that the topic being published is in the handler's declared `publishes` array. For producers, it checks `workflowConfig.producers[handlerName].publishes`. For consumers in next phase, it checks `workflowConfig.consumers[handlerName].publishes`.

== FILES CHANGED ==

1. packages/agent/src/handler-state-machine.ts (+24 lines)
   - Parse handler_config JSON to WorkflowConfig (lines 759-767)
   - Create toolWrapperRef for circular dependency (line 770)
   - Add getPhase/getHandlerName/getWorkflowConfig to createWorkflowTools call
   - Set toolWrapperRef.current after ToolWrapper creation

2. packages/agent/src/sandbox/tool-lists.ts (+6 lines)
   - Add getHandlerName and getWorkflowConfig to ToolListConfig interface
   - Destructure and pass them to makeTopicsPublishTool

3. packages/agent/src/tools/topics.ts (+26 lines)
   - Add getHandlerName and getWorkflowConfig parameters to makeTopicsPublishTool
   - Implement topic declaration validation in execute() function

== POTENTIAL ISSUES ==

1. SILENT FAILURE ON INVALID CONFIG (Medium)
   Location: handler-state-machine.ts:764-766

   If handler_config contains invalid JSON, the catch block silently swallows the error
   and sets workflowConfig = undefined. This means topic validation will be silently
   skipped for workflows with corrupted config.

   PROPOSAL: Log a warning when JSON parsing fails so debugging is possible:
   ```typescript
   } catch (e) {
     log(`Warning: Failed to parse handler_config for workflow ${workflow.id}: ${e}`);
   }
   ```

2. MISSING VALIDATION WHEN declaredTopics IS UNDEFINED (Low)
   Location: topics.ts:275

   The validation only runs when `declaredTopics` is truthy. If a producer doesn't have
   a `publishes` field (old workflow format), validation is silently skipped. This is
   intentional for backward compatibility, but could mask misconfigured workflows.

   PROPOSAL: This behavior is correct for backward compatibility. No change needed.

3. INCONSISTENT PHASE FILTERING IN getPhase CALLBACK (Low)
   Location: handler-state-machine.ts:681-685

   The getPhase callback returns null for phases other than 'producer' or 'next':
   ```typescript
   if (phase === 'producer' || phase === 'next') return phase;
   return null;
   ```

   This is intentional since only these phases can publish, but the comment could
   be clearer about why other phases return null.

   PROPOSAL: The implementation is correct. Consider adding a more detailed comment.

4. REF PATTERN COMPLEXITY (Low)
   Location: handler-state-machine.ts:770, 804

   The toolWrapperRef pattern is used to solve a circular dependency where:
   - createWorkflowTools needs getPhase callback
   - getPhase needs toolWrapper.getPhase()
   - ToolWrapper needs the tools from createWorkflowTools

   The ref pattern is a standard React-inspired solution, but adds indirection.

   PROPOSAL: Consider documenting why this pattern is needed with a comment.

== CODE QUALITY ==

- Clean separation of concerns: config parsing, tool creation, and validation are
  in appropriate locations
- Optional chaining used correctly: `workflowConfig.producers?.[handlerName]?.publishes`
- Error messages are descriptive and include handler name and declared topics
- The implementation correctly handles both single-topic and multi-topic publish

== BACKWARD COMPATIBILITY ==

The implementation is fully backward compatible:
- Old workflows without handler_config will have workflowConfig = undefined
- When workflowConfig is undefined, topic validation is skipped
- Existing workflows continue to work without modification

== VERDICT ==

This is a well-implemented phase of exec-15. The handler context threading enables
runtime validation of topic declarations, preventing scripts from publishing to
undeclared topics. The ref pattern is a clean solution to the circular dependency.

Minor issues: Silent failure on JSON parse could benefit from logging.

================================================================================
ISSUE REVIEW
================================================================================
- Issue #1 (Silent failure on invalid config) - skipped (medium severity, but tx-based workflows mitigate, systemic pattern across codebase)
- Issue #2 (Missing validation when declaredTopics undefined) - skipped (low severity, backward compat by design)
- Issue #3 (Inconsistent phase filtering in getPhase) - skipped (low severity, correct behavior)
- Issue #4 (Ref pattern complexity) - skipped (low severity, standard pattern)

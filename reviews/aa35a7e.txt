COMMIT REVIEW: aa35a7e
=======================
fix: Implement bug fixes for task creation and script activation

CHANGES OVERVIEW
----------------
This commit addresses four distinct bug fixes:

1. **Error Toast for Task Creation Failure (MainPage.tsx)**
   - Added `submitError` and `uploadWarning` state variables
   - Shows red error banner when task creation fails via API
   - Shows yellow warning banner when file uploads fail (but task creation continues)
   - States are cleared at the start of each submission attempt

2. **File Upload Failure Warning (MainPage.tsx)**
   - When file upload fails in handleSubmit, instead of silently proceeding,
     now sets uploadWarning: "Some files failed to upload and were not attached."
   - Task creation still continues (graceful degradation preserved)
   - User is now informed about missing attachments

3. **HTTP Status Check in useNeedAuth (useNeedAuth.ts)**
   - Added `if (!configResponse.ok)` check before parsing JSON from /check_config
   - Prevents cryptic JSON parse errors when server returns HTML error pages
   - Throws descriptive error: "Failed to check config: HTTP ${status}"

4. **Transaction Wrapper for Script Activation (dbWrites.ts, script-store.ts)**
   - Wrapped useActivateScriptVersion in `api.db.db.tx()` transaction
   - Added optional `tx?: DBInterface` parameter to ScriptStore.getScript()
   - Prevents TOCTOU (Time-of-Check-to-Time-of-Use) vulnerability
   - Both validation and update now execute atomically

FILES CHANGED
-------------
- apps/web/src/components/MainPage.tsx: +22 lines for error/warning UI
- apps/web/src/hooks/dbWrites.ts: Refactored to use transaction wrapper
- apps/web/src/hooks/useNeedAuth.ts: +3 lines for HTTP status check
- packages/db/src/script-store.ts: Added tx parameter to getScript()
- specs/done/*: 4 spec files documenting the fixes
- IMPLEMENTATION_PLAN.md: Updated with completion notes

POTENTIAL ISSUES
----------------

### Issue 1: submitError and uploadWarning Not Cleared on Navigation
**Severity:** Low
**Location:** MainPage.tsx lines 267-268, 305-306

The error states are cleared at the start of each submission but not when the
user navigates away and returns. If a user gets an error, navigates elsewhere,
and returns, they'll see a fresh page (React remounts). However, if MainPage
is kept mounted (e.g., via route caching), stale errors could persist.

**Proposal:** This is likely fine since MainPage remounts on navigation. No action
needed unless route caching is added later.

### Issue 2: Transaction Not Passed to updateWorkflowFields Correctly
**Severity:** Critical - CONFIRMED BUG
**Location:** dbWrites.ts line 221-223

The code calls:
```typescript
await api.scriptStore.updateWorkflowFields(input.workflowId, {
  active_script_id: input.scriptId,
}, tx);
```

BUT: Looking at script-store.ts, the updateWorkflowFields method signature is:
```typescript
async updateWorkflowFields(
  workflowId: string,
  fields: Partial<Pick<Workflow, ...>>,
  tx?: DBInterface
): Promise<void>
```

The method DOES accept tx as the third parameter. This is CORRECT.

**Status:** Not a bug - verified that updateWorkflowFields accepts tx parameter.

### Issue 3: Error Message Not Specific Enough
**Severity:** Low
**Location:** MainPage.tsx line 306

The error message is generic: "Failed to create automation. Please try again."
It doesn't distinguish between network errors, validation errors, or server errors.

**Proposal:** Consider adding error categorization:
- Network errors: "Unable to connect. Check your internet connection."
- Validation errors: Show the specific validation message
- Server errors: "Server error. Please try again later."

### Issue 4: File Upload Warning Could Show Even on Success
**Severity:** Very Low (Cosmetic)
**Location:** MainPage.tsx lines 290-292

If file upload throws but task creation succeeds and navigates away, the warning
is set but user never sees it (they're already on the new page). This is fine -
no user-facing impact.

### Issue 5: useNeedAuth Polling Every 5 Seconds
**Severity:** Low
**Location:** useNeedAuth.ts (not in this commit, but related)

The hook polls /check_config every 5 seconds. The HTTP status check prevents
JSON parse errors, but the polling itself seems excessive for config checking.

**Proposal:** Not in scope for this commit, but consider:
- Increase interval to 30 seconds
- Use exponential backoff on errors
- Only poll when window is visible

ARCHITECTURAL NOTES
-------------------

1. **Transaction Pattern Consistency:**
   The useActivateScriptVersion is now the ONLY hook in dbWrites.ts that uses
   explicit transactions. This is appropriate since it's the only one with
   a genuine TOCTOU risk (validation then update of related records).

2. **Error Handling Tiers:**
   MainPage now has a clear three-tier error handling:
   - Tier 1: Upload errors (warning, continues)
   - Tier 2: Task creation errors (blocking, shows error)
   - Tier 3: Upload state errors (from hook, critical)

3. **Graceful Degradation:**
   The file upload failure handling correctly implements graceful degradation -
   task creation proceeds without attachments, but user is informed.

VERDICT
-------
Well-implemented fixes. The transaction wrapper is the most important change,
preventing a real (albeit low-probability) data integrity issue. The error
notifications significantly improve UX for edge cases.

No critical bugs found. Minor improvements possible in error message specificity.
